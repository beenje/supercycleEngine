
record(calcout, "$(P)$(R=)Trig-Cnt_")
{
    field(DESC, "Trigger Counter")
    field(CALC, "A+B")
    #field(SCAN, "1 second")
    field(SCAN, "Passive")
    field(INPA, "$(PG)SoftSeq0-NumOfStarts-I CP")
    field(INPB, "$(PG)SoftSeq1-NumOfStarts-I CP")

    field(FLNK, "$(P)$(R=)EngineCycle_")
}

record(aSub, "$(P)$(R=)EngineCycle_") {
    field(INAM, "initEngine")
    field(SNAM, "ioEngine")
    field(SCAN, "Passive")
    #alias("$(P)$(R=)IdCycle")
    # Outputs
    field(FTVA, "ULONG")
    field(NOVA, "2046")
    field(FTVB, "ULONG")
    field(NOVB, "2046")
    field(FTVC, "ULONG")
    field(NOVC, "2046")
    field(FTVD, "ULONG")
    field(NOVD, "2046")
    field(FTVE, "ULONG")
    field(NOVE, "2046")

    #field(OUTB, "$(PG)dbus-send-u32")
    # Alternate
    #field(OUTC, "$(PG)SoftSeq0-Timestamp-SP")
    #field(OUTD, "$(PG)SoftSeq0-EvtCode-SP")

    # Inputs
    field(FTA, "ULONG")
    field(NOA, "10")
    #field(INPA, "")

    field(FLNK, "$(P)$(R=)Trig-FOut_")
}

record(fanout, "$(P)$(R=)Trig-FOut_") {
    field(DESC, "Trigger Fanout")
    field(SELM, "All")
    #field(PINI, "RUNNING")
    field(LNK0, "$(P)$(R=)Sel-Addr_")
    field(LNK1, "$(P)$(R=)IdCycle")
    field(LNK2, "$(P)$(R=)Period")
    field(LNK3, "$(P)$(R=)Databuffer")
    field(LNK4, "$(P)$(R=)Timestamps")
    field(LNK5, "$(P)$(R=)Events")
    field(LNK6, "$(P)$(R=)Sequence")
    field(LNK7, "$(P)$(R=)COffset-Seq_")
}

record(seq, "$(P)$(R=)COffset-Seq_") {
    field(DESC, "Cycle Offset")
    field(SELM, "All")
    field(PINI, "RUNNING")
    field(SCAN, "Passive")
    #field(DOL1, "")
    field(DO1, "1")
    field(DLY1, "0.03")
    field(LNK1, "$(P)$(R=)DBuf-Send-aSubBuf_.INPU CA")
    field(FLNK, "$(P)$(R=)DBuf-Send-aSubBuf_")
    #field(TPRO, "1")
}

record(aSub, "$(P)$(R=)DBuf-Send-aSubBuf_") {
    field(DESC, "Databuffer Buf")
    field(SNAM, "ioASubBuf")
    field(SCAN, "Passive")

    field(FTA, "ULONG")
    field(NOA, "2046")
    field(FTVA, "ULONG")
    field(NOVA, "2046")

    # Processing trigger
    field(FTU, "ULONG")
    field(NOU, "1")
    #field(INPU, "$(P)$(R=)COffset-Seq_.LNK1 CA")

    field(INPA, "$(P)$(R=)EngineCycle_.VALB")
    field(OUTA, "$(PG)dbus-send-u32 CP")

    field(FLNK, "$(P)$(R=)CEnd-lOut_")
    #field(TPRO, "1")
}

record(longout, "$(P)$(R=)CEnd-lOut_") {
    field(DESC, "Cycle End EVT")
    field(SCAN, "Passive")
    field(VAL,  "$(EVCEND)")
    field(OUT,  "$(PG)SoftEvt-EvtCode-SP  CP")
}

record(int64in, "$(P)$(R=)IdCycle") {
    field(DESC, "ID Cycle")
    field(DTYP, "Soft Channel")
    field(SCAN, "Passive")
    field(EGU, "id")
    field(INP, "$(P)$(R=)EngineCycle_.VALA")
    alias("$(P)$(R=)HEARTBEAT")
}

record(longin, "$(P)$(R=)Period") {
    field(DESC, "Actuall Cycle Frequency")
    field(DTYP, "Soft Channel")
    field(SCAN, "Passive")
    field(EGU, "us")
    field(INP, "$(P)$(R=)Period-subA_")

    #field(FLNK, "$(P)$(R=)Seq0-En-Cmd")
    field(HIHI, "91000")
	field(HIGH, "81000")
	field(LOW,  "61000")
	field(LOLO, "51000")
    field(HHSV, "MAJOR")
	field(HSV,  "MINOR")
	field(LSV,  "MINOR")
	field(LLSV, "MAJOR")
}

record(subArray, "$(P)$(R=)Period-subA_") {
    field(DTYP, "Soft Channel")
    field(INP, "$(P)$(R=)EngineCycle_.VALA")
    field(INDX, "2")
    field(NELM, "1") # "2046")
    field(MALM, "3") # "2046")
    field(FTVL, "ULONG")
}

record(waveform, "$(P)$(R=)Databuffer") {
    field(DTYP, "Soft Channel")
    field(SCAN, "Passive")
    field(FTVL, "ULONG")
    field(INP, "$(P)$(R=)EngineCycle_.VALB")
    #field(INDX, "0")
    field(NELM, "2046") # "2046")
}

record(waveform, "$(P)$(R=)Timestamps") {
    field(DTYP, "Soft Channel")
    field(SCAN, "Passive")
    field(FTVL, "ULONG")
    field(INP, "$(P)$(R=)EngineCycle_.VALC")
    #field(INDX, "0")
    field(NELM, "2046") # "2046")
}

record(waveform, "$(P)$(R=)Events") {
    field(DTYP, "Soft Channel")
    field(SCAN, "Passive")
    field(FTVL, "ULONG")
    field(INP, "$(P)$(R=)EngineCycle_.VALD")
    #field(INDX, "0")
    field(NELM, "2046") # "2046")
}

record(waveform, "$(P)$(R=)Sequence") {
    field(DTYP, "Soft Channel")
    field(SCAN, "Passive")
    field(FTVL, "ULONG")
    field(INP, "$(P)$(R=)EngineCycle_.VALE")
    #field(INDX, "0")
    field(NELM, "2046") # "2046")
}

record(calcout, "$(P)$(R=)Sel-Addr_") {
    field(DESC, "Select Address")
    field(CALC, "(A<1)?A+1:0")
    field(SCAN, "Passive")
    field(INPA, "$(P)$(R=)Sel-Addr_")
    field(FLNK, "$(P)$(R=)Sel-Mask_")
}

record(calcout, "$(P)$(R=)Sel-Mask_") {
    field(DESC, "Select Address")
    field(CALC, "(A>0)?0xFF00:0x00FF")
    field(SCAN, "Passive")
    field(INPA, "$(P)$(R=)Sel-Addr_")

    field(FLNK, "$(P)$(R=)Seq-Sel-FOut_")
}

#==========

record(fanout, "$(P)$(R=)Seq-Sel-FOut_") {
    field(DESC, "Seq Selector Fanout")
    field(SELM, "Mask")
    field(SHFT, "0")
    field(OFFS, "0")
    field(SELL, "$(P)$(R=)Sel-Mask_")
    #field(PINI, "FALSE")
    field(LNK0, "$(P)$(R=)Seq0-Tst-aSubBuf_")
    field(LNK1, "$(P)$(R=)Seq0-Evt-aSubBuf_")
    field(LNKE, "$(P)$(R=)Seq1-Tst-aSubBuf_")
    field(LNKF, "$(P)$(R=)Seq1-Evt-aSubBuf_")
}

record(aSub, "$(P)$(R=)Seq0-Tst-aSubBuf_") {
    field(DESC, "Timestamp Array Buffer")
    field(SNAM, "ioASubBuf")
    field(SCAN, "Passive")

    field(FTA, "ULONG")
    field(NOA, "2046")
    field(FTVA, "ULONG")
    field(NOVA, "2046")

    field(INPA, "$(P)$(R=)EngineCycle_.VALC")
    field(OUTA, "$(PG)SoftSeq0-Timestamp-SP CP")
}

record(aSub, "$(P)$(R=)Seq0-Evt-aSubBuf_") {
    field(DESC, "Timestamp Array Buffer")
    field(SNAM, "ioASubBuf")
    field(SCAN, "Passive")

    field(FTA, "ULONG")
    field(NOA, "2046")
    field(FTVA, "ULONG")
    field(NOVA, "2046")

    field(INPA, "$(P)$(R=)EngineCycle_.VALD")
    field(OUTA, "$(PG)SoftSeq0-EvtCode-SP CP")

    field(FLNK, "$(P)$(R=)Seq0-Ctrl-FOut_")
}

record(aSub, "$(P)$(R=)Seq1-Tst-aSubBuf_") {
    field(DESC, "Timestamp Array Buffer")
    field(SNAM, "ioASubBuf")
    field(SCAN, "Passive")

    field(FTA, "ULONG")
    field(NOA, "2046")
    field(FTVA, "ULONG")
    field(NOVA, "2046")

    field(INPA, "$(P)$(R=)EngineCycle_.VALC")
    field(OUTA, "$(PG)SoftSeq1-Timestamp-SP CP")
}

record(aSub, "$(P)$(R=)Seq1-Evt-aSubBuf_") {
    field(DESC, "Timestamp Array Buffer")
    field(SNAM, "ioASubBuf")
    field(SCAN, "Passive")

    field(FTA, "ULONG")
    field(NOA, "2046")
    field(FTVA, "ULONG")
    field(NOVA, "2046")

    field(INPA, "$(P)$(R=)EngineCycle_.VALD")
    field(OUTA, "$(PG)SoftSeq1-EvtCode-SP CP")

    field(FLNK, "$(P)$(R=)Seq1-Ctrl-FOut_")
}

record(fanout, "$(P)$(R=)Seq0-Ctrl-FOut_") {
    field(DESC, "Seq Selector Fanout")
    field(SELM, "All")
    #field(PINI, "RUNNING")
    field(LNK1, "$(PG)SoftSeq1-Disable-Cmd.PROC CP")
    field(LNK2, "$(PG)SoftSeq0-Commit-Cmd.PROC CP")
    field(LNK3, "$(PG)SoftSeq0-Enable-Cmd.PROC CP")
}

record(fanout, "$(P)$(R=)Seq1-Ctrl-FOut_") {
    field(DESC, "Seq Selector Fanout")
    field(SELM, "All")
    #field(PINI, "RUNNING")
    field(LNK1, "$(PG)SoftSeq0-Disable-Cmd.PROC CP")
    field(LNK2, "$(PG)SoftSeq1-Commit-Cmd.PROC CP")
    field(LNK3, "$(PG)SoftSeq1-Enable-Cmd.PROC CP")
}
